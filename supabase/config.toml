# Production-Ready Supabase Configuration
# https://supabase.com/docs/guides/local-development/cli/config

project_id = "phone-repair"

[api]
enabled = true
port = 54322
schemas = ["public", "graphql_public"]
extra_search_path = ["public", "extensions"]
max_rows = 1000

[api.tls]
enabled = false

[db]
port = 54326
shadow_port = 54321
major_version = 17

[db.pooler]
enabled = true
port = 54329
pool_mode = "transaction"
default_pool_size = 20
max_client_conn = 100

[db.migrations]
enabled = true
schema_paths = []

[db.seed]
enabled = false  # Disable seeding in production
sql_paths = ["./seed.sql"]

[db.network_restrictions]
enabled = true
# Restrict to specific IP ranges in production
# Add your application server IPs, office IPs, etc.
allowed_cidrs = ["0.0.0.0/0"]  # UPDATE THIS with specific IPs
allowed_cidrs_v6 = ["::/0"]    # UPDATE THIS with specific IPs

[realtime]
enabled = true
max_header_length = 4096

[studio]
enabled = true
port = 54324
api_url = "http://127.0.0.1"
openai_api_key = "env(OPENAI_API_KEY)"

[inbucket]
enabled = false  # Disable email testing in production

[storage]
enabled = true
file_size_limit = "50MiB"

# Configure storage buckets for production
[storage.buckets.avatars]
public = true
file_size_limit = "5MiB"
allowed_mime_types = ["image/png", "image/jpeg", "image/webp"]

[storage.buckets.repair-images]
public = false
file_size_limit = "10MiB"
allowed_mime_types = ["image/png", "image/jpeg", "image/webp"]

[storage.buckets.invoices]
public = false
file_size_limit = "5MiB"
allowed_mime_types = ["application/pdf"]

[auth]
enabled = true
site_url = "https://jays-shop.vercel.app"

# Strict redirect URLs - only your production domains
additional_redirect_urls = [
  "https://jays-shop.vercel.app",
  "https://jays-shop.vercel.app/**"
]

jwt_expiry = 3600  # 1 hour

# Enable secure token rotation
enable_refresh_token_rotation = true
refresh_token_reuse_interval = 0  # No reuse for maximum security

# Production-grade rate limiting
[auth.rate_limit]
email_sent = 5           # 5 emails per hour per user
sms_sent = 3             # 3 SMS per hour per user
anonymous_users = 10     # 10 anonymous sign-ins per hour per IP
token_refresh = 50       # 50 token refreshes per 5 min per IP
sign_in_sign_ups = 20    # 20 sign-in/sign-up attempts per 5 min per IP
token_verifications = 10 # 10 OTP verifications per 5 min per IP
web3 = 10

# Enable captcha for production (recommended)
[auth.captcha]
enabled = true
provider = "turnstile"  # or "hcaptcha"
secret = "env(CAPTCHA_SECRET_KEY)"

[auth.email]
enable_signup = true
double_confirm_changes = true
enable_confirmations = true      # REQUIRED for production
secure_password_change = true    # Force reauthentication for password changes
max_frequency = "60s"            # Prevent email spam
otp_length = 6
otp_expiry = 3600               # 1 hour OTP validity

# Production SMTP configuration - REQUIRED
[auth.email.smtp]
enabled = true
host = "smtp.sendgrid.net"      # or your SMTP provider
port = 587
user = "apikey"
pass = "env(SENDGRID_API_KEY)"  # Set in environment variables
admin_email = "admin@jays-shop.com"
sender_name = "Jay's Phone Repair"

# Custom email templates (optional but recommended)
[auth.email.template.invite]
subject = "Welcome to Jay's Phone Repair"
content_path = "./supabase/templates/invite.html"

[auth.email.template.confirmation]
subject = "Confirm Your Email - Jay's Phone Repair"
content_path = "./supabase/templates/confirmation.html"

[auth.email.template.recovery]
subject = "Reset Your Password - Jay's Phone Repair"
content_path = "./supabase/templates/recovery.html"

[auth.email.template.magic_link]
subject = "Your Magic Link - Jay's Phone Repair"
content_path = "./supabase/templates/magic_link.html"

[auth.sms]
enable_signup = false
enable_confirmations = false
template = "Your Jay's Phone Repair verification code is {{ .Code }}"
max_frequency = "60s"  # Prevent SMS spam

# Configure session timeouts
[auth.sessions]
timebox = "24h"              # Force logout after 24 hours
inactivity_timeout = "2h"    # Logout after 2 hours of inactivity

# Custom JWT claims for role-based access
[auth.hook.custom_access_token]
enabled = true
uri = "pg-functions://postgres/public/set_role_claim_in_jwt"

# SMS provider (enable if needed)
[auth.sms.twilio]
enabled = false
account_sid = "env(TWILIO_ACCOUNT_SID)"
message_service_sid = "env(TWILIO_MESSAGE_SERVICE_SID)"
auth_token = "env(TWILIO_AUTH_TOKEN)"

# Multi-factor authentication
[auth.mfa]
max_enrolled_factors = 10

[auth.mfa.totp]
enroll_enabled = true   # Enable TOTP for production
verify_enabled = true

[auth.mfa.phone]
enroll_enabled = false  # Enable if SMS is configured
verify_enabled = false
otp_length = 6
template = "Your 2FA code is {{ .Code }}"
max_frequency = "60s"

# OAuth providers (configure as needed)
[auth.external.google]
enabled = true
client_id = "env(GOOGLE_CLIENT_ID)"
secret = "env(GOOGLE_CLIENT_SECRET)"
skip_nonce_check = false

[auth.external.apple]
enabled = false
client_id = "env(APPLE_CLIENT_ID)"
secret = "env(APPLE_CLIENT_SECRET)"
redirect_uri = ""
url = ""
skip_nonce_check = false

# Edge Runtime for serverless functions
[edge_runtime]
enabled = true
policy = "per_worker"
inspector_port = 8083
deno_version = 2

# Store secrets in environment variables
# [edge_runtime.secrets]
# STRIPE_SECRET_KEY = "env(STRIPE_SECRET_KEY)"
# TWILIO_AUTH_TOKEN = "env(TWILIO_AUTH_TOKEN)"
# OPENAI_API_KEY = "env(OPENAI_API_KEY)"

[analytics]
enabled = true
port = 54327
backend = "postgres"

# Experimental features (use with caution in production)
[experimental]
orioledb_version = ""
s3_host = "env(S3_HOST)"
s3_region = "env(S3_REGION)"
s3_access_key = "env(S3_ACCESS_KEY)"
s3_secret_key = "env(S3_SECRET_KEY)"

# ============================================
# PRODUCTION DEPLOYMENT CHECKLIST
# ============================================
# 
# Before deploying to production, ensure:
# 
# 1. Environment Variables Set:
#    - SENDGRID_API_KEY (or your SMTP credentials)
#    - CAPTCHA_SECRET_KEY (Turnstile/hCaptcha)
#    - GOOGLE_CLIENT_ID & GOOGLE_CLIENT_SECRET (if using OAuth)
#    - TWILIO credentials (if using SMS)
#    - S3 credentials (if using S3 storage)
#    - OPENAI_API_KEY (if using AI features)
#
# 2. Database Security:
#    - Enable Row Level Security (RLS) on all tables
#    - Review and test all RLS policies
#    - Set up proper database backups
#    - Configure network restrictions (allowed_cidrs)
#
# 3. Email Configuration:
#    - Test all email templates
#    - Verify SMTP credentials work
#    - Set up SPF, DKIM, DMARC records for your domain
#    - Use a custom domain for emails (not @jays-shop.vercel.app)
#
# 4. Authentication:
#    - Test email confirmation flow
#    - Test password reset flow
#    - Test OAuth providers
#    - Enable and test MFA
#    - Review rate limits for your use case
#
# 5. Storage:
#    - Set up storage policies for each bucket
#    - Test file upload limits
#    - Configure CDN if needed
#    - Set up automatic image optimization
#
# 6. Monitoring:
#    - Set up logging and monitoring
#    - Configure alerts for suspicious activity
#    - Monitor rate limit hits
#    - Track authentication failures
#
# 7. Legal & Compliance:
#    - Add privacy policy
#    - Add terms of service
#    - Ensure GDPR compliance (if applicable)
#    - Set up data retention policies
#
# 8. Performance:
#    - Enable connection pooling
#    - Configure appropriate max_rows limits
#    - Test under load
#    - Set up CDN for static assets
#
# 9. Security Hardening:
#    - Use environment variables for ALL secrets
#    - Never commit secrets to git
#    - Regularly rotate API keys
#    - Use HTTPS everywhere
#    - Enable captcha on auth forms
#    - Implement rate limiting on Edge Functions
#
# 10. Disaster Recovery:
#     - Set up automated backups
#     - Test backup restoration
#     - Document recovery procedures
#     - Have rollback plan ready
#
# ============================================